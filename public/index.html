<!DOCTYPE html>
<!-- نفس كود الـ HTML والـ CSS الخاص بك بالكامل، مع تعديل جزء الـ SCRIPT فقط -->
<html lang="en" dir="ltr" data-theme="light">
<head>
    <!-- ... كل محتويات الـ head كما هي ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMSU - Evaluation System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... كل كود الـ CSS الخاص بك كما هو ... */
        :root {
            --color-red: #d92525; --color-red-dark: #b81e1e; --color-black: #121212;
            --color-white: #ffffff; --font-family: 'Cairo', sans-serif; --glow-color: rgba(217, 37, 37, 0.7   );
        }
        /* ... إلخ ... */
    </style>
</head>
<body>
    <!-- ... كل محتويات الـ body كما هي ... -->
    <div class="news-ticker">
        <!-- ... -->
    </div>
    <!-- ... إلخ ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- كل الكود الخاص بك للـ animations والـ theme يعمل كما هو ---
            const tickerContent = document.querySelector('.news-ticker-content');
            tickerContent.innerHTML += tickerContent.innerHTML;
            // ... إلخ ...

            const mainContent = document.getElementById('main-content');
            const codeInput = document.getElementById('code-input');
            const searchBtn = document.getElementById('search-btn');
            const loaderContainer = document.getElementById('loader-container');
            const resultsContainer = document.getElementById('results-container');
            const themeToggle = document.getElementById('theme-toggle');
            let currentMemberCode = null;

            // =================================================================
            //          *** بداية الجزء المعدل ***
            // =================================================================

            async function handleSearch() {
                currentMemberCode = codeInput.value.trim();
                if (!currentMemberCode) {
                    alert('Please enter a Member ID.');
                    return;
                }

                loaderContainer.classList.add('visible');
                mainContent.style.display = 'none';
                resultsContainer.style.display = 'none';
                resultsContainer.innerHTML = '';

                try {
                    // استدعاء الدالة السحابية على Vercel بدلاً من google.script.run
                    const response = await fetch(`/api/get-data?code=${encodeURIComponent(currentMemberCode)}`);
                    const res = await response.json();

                    if (!response.ok) {
                        // إذا كان هناك خطأ من الخادم (مثل 500)
                        throw new Error(res.message || 'An unknown server error occurred.');
                    }
                    
                    // الآن `res` يحتوي على نفس البيانات التي كانت تأتي من getEvaluation
                    displayResults(res);

                } catch (error) {
                    console.error("Fetch Error:", error);
                    displayError({ message: error.message });
                }
            }

            function handlePdfExport() {
                // هذه الوظيفة تتطلب عملاً إضافياً كبيراً باستخدام Google Drive API
                // تم تعطيلها مؤقتاً
                alert("PDF export functionality is currently under development for this platform.");
                
                /*
                const btn = document.getElementById('export-pdf-btn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                // هنا ستحتاج إلى استدعاء دالة سحابية أخرى خاصة بإنشاء الـ PDF
                // fetch(`/api/create-pdf?code=${currentMemberCode}`)...
                */
            }

            // =================================================================
            //          *** نهاية الجزء المعدل ***
            // =================================================================

            function resetToSearch() {
                resultsContainer.style.display = 'none';
                mainContent.style.display = 'block';
                codeInput.value = '';
                currentMemberCode = null;
            }

            function displayResults(res) {
                loaderContainer.classList.remove('visible');
                if (!res.found || !res.data) {
                    alert(res.message || 'Member ID not found.');
                    resetToSearch();
                    return;
                }
                
                const member = res.data;
                
                // --- باقي دالة displayResults تعمل كما هي تماماً بدون أي تغيير ---
                let avatarContent;
                const photoUrl = member['DirectPhotoLink'];
                if (photoUrl && String(photoUrl).trim() !== '') {
                    avatarContent = `<img src="${photoUrl}" alt="Member Photo">`;
                } else {
                    const initial = member.Name ? member.Name.charAt(0).toUpperCase() : '?';
                    avatarContent = `<div class="profile-avatar-placeholder">${initial}</div>`;
                }
                // ... إلخ ...
                // ... كل كود بناء الـ HTML الخاص بك يوضع هنا كما هو ...
                resultsContainer.innerHTML = `
                    <div class="profile-card">
                        <!-- ... -->
                    </div>
                    <div class="evaluation-card">
                        <!-- ... -->
                        <div class="card-actions">
                            <button id="new-search-btn" class="btn btn-new-search"><i class="fas fa-search"></i> New Search</button>
                            <button id="export-pdf-btn" class="btn btn-primary" title="This feature is under development"><i class="fas fa-file-pdf"></i> Export PDF</button>
                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfh9MTlGCh4YNmFazSKapdDm_ISOLVIghNH2Tqu3_zrdxUBmQ/viewform?usp=header" target="_blank" class="btn btn-secondary">
                                <i class="fas fa-exclamation-triangle"></i> Complaint
                            </a>
                        </div>
                    </div>`;
                
                resultsContainer.style.display = 'block';

                createDoughnutChart('totalScoreChart', parseInt(member.Total || 0 ), 100, document.documentElement.getAttribute('data-theme'));
                createDoughnutChart('percentageChart', parseFloat(member['%'] || 0), 100, document.documentElement.getAttribute('data-theme'));
                
                document.getElementById('new-search-btn' ).addEventListener('click', resetToSearch);
                document.getElementById('export-pdf-btn').addEventListener('click', handlePdfExport);
                
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        header.classList.toggle('active');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                });

                if (photoUrl && String(photoUrl).trim() !== '') {
                    setupImageModal(photoUrl);
                }
            }

            function displayError(error) {
                loaderContainer.classList.remove('visible');
                resetToSearch();
                alert(`An error occurred: ${error.message}`);
            }

            // --- باقي الدوال المساعدة (createDoughnutChart, setupImageModal, applyTheme, etc.) تبقى كما هي ---
            // ...
        });
    </script>
</body>
</html>
